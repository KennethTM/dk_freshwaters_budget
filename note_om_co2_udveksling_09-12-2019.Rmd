---
title: "Afgasning af kuldioxid fra Danmarks søer og vandløb"
author: "Kenneth Thorø Martinsen"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: html_document
---

```{r setup, include=FALSE}

#knitr::opts_chunk$set(cache=TRUE)

library(tidyverse);library(lubridate);library(sf);library(seacarb)
library(knitr);library(kableExtra);library(lwgeom);library(patchwork)

set.seed(9999)

data_path <- paste0(getwd(), "/data/")
rawdata_path <- paste0(getwd(), "/rawdata/")

dk_epsg <- 3044 #25832

#hvis perioden skal udvides skal der hentes yderligere sø data (se gammelt script for prep)
#overvej at gøre hele analysen reproducerbar
time_start <- ymd("1989-01-01")
time_end <- ymd("2010-12-31")

dk_carb <- readRDS(paste0(data_path, "dk_carb.rds")) %>% 
  tbl_df() %>% 
  filter(between(date, time_start, time_end)) %>% 
  filter(alk > 0 & alk < 10, 
         wtr < 40,
         ph > 5.4,
         pCO2_uatm < 40000)
         
#vl og so pco2
vl_pco2 <- dk_carb %>%
  filter(system == "vl") %>% 
  st_as_sf(coords = c("x_coord", "y_coord"), crs = dk_epsg)

so_pco2 <- dk_carb %>%
  filter(system == "so") %>%
  select(-q_m3_s) %>% 
  st_as_sf(coords = c("x_coord", "y_coord"), crs = dk_epsg)

#dk climate grid 20x20 km 1990-2010
wnd_grid <- read.delim(paste0(rawdata_path, "tr12-10_20x20km/daily_20x20km_wind speed_1989-2010.txt"),
                       sep = ";", stringsAsFactors = FALSE) %>%
  tbl_df() %>%
  rename(wnd = X20.20km_Mean_wind_speed_.m.s., 
         dmi_cell = gridcelle) %>%
  mutate(date = ymd(paste(year, month, day, sep = "-"))) %>%
  select(date, dmi_cell, utm_zone, eastings, northings, wnd)

wnd_grid_sf <- wnd_grid %>%
  select(dmi_cell, eastings, northings) %>%
  distinct() %>%
  st_as_sf(coords = c("eastings", "northings"), crs = 23032) %>% 
  st_transform(dk_epsg)

#dk lakes
lakes <- readRDS(paste0(data_path, "lakes.rds"))

#dk lakes pco2 med vind og areal
so_pco2_sf <- so_pco2 %>%
  st_join(wnd_grid_sf, join = st_nearest_feature) %>%
  st_join(lakes) %>% #nogen punkter joiner med flere polygoner, fjernes for at undgå dobbelt co2 flux data
  left_join(wnd_grid[, c("date", "dmi_cell", "wnd")])

#dk stream
streams_drop <- readRDS(paste0(data_path, "streams_slope.rds")) %>% 
  st_as_sf() #%>% 
  #filter(length > 10 & !is.na(slope))

#dk stream med slope
vl_pco2_sf <- vl_pco2 %>%
    st_join(streams_drop, join = st_nearest_feature)

```

# Introduction
This analysis attempts to estimate the carbon dioxide (CO~2~) emissions from Danish inland waters. The data in this analysis is compiled from Miljøportalen/Odaforalle which stores data from the Danish monitoring program. CO~2~ partial pressure is estimated from water temperature, alkalinity and pH. The gas transfer velocity (*k*) is estimated from empirical relationships parameterized by wind (lakes) or hydrological variables (streams). GIS layers containing the outline of Danish inland waters allow extraction of area (lakes) and length (streams and rivers) data. The  uncertainty in the upscaling of CO~2~ gas flux to national scale is quantified using a Monte Carlo simulation.

## Lakes

### Number and size distribution of Danish lakes

In order to constrain the estimation of carbon dioxide (CO~2~) emissions from Danish lakes knowledge on the size distribution of Danish lakes is required. This analysis is based on data set <https://download.kortforsyningen.dk/content/inspirehy-standingwater> with `r nrow(lakes)` Danish lake surfaces covering a total of `r format(sum(lakes$area)*10^-6, digits = 0)` km^2^. Lakes are split into six size classes according to their size (m^2^). Plots show the number of lakes in each size class (left) and the combined area of each size class (right). The tables summarizes the data.

```{r danske_soer, echo=FALSE, fig.height = 4, fig.width = 10}
lake_size <- lakes %>% 
  st_set_geometry(NULL) %>% 
  mutate(sizecat = cut(area, breaks = c(0, 1000, 10^4, 10^5, 10^6, 10^7, 10^8), right = FALSE)) %>% 
  group_by(sizecat) %>% 
  summarise(Number = n(), Sum = sum(area)) %>% 
  mutate(Size = c("0-10^3^", "10^3^-10^4^", "10^4^-10^5^", "10^5^-10^6^", "10^6^-10^7^", "10^7^-10^8^")) 

label.class <- c(expression("0-10"^3), expression("10"^3*"-10"^4), expression("10"^4*"-10"^5),
           expression("10"^5*"-10"^6), expression("10"^6*"-10"^7), expression("10"^7*"-10"^8))

antal <- ggplot(lake_size, aes(Size, Number)) + 
  geom_col() + 
  scale_y_log10() +
  scale_x_discrete(labels = label.class) +
  theme_bw()

areal <- ggplot(lake_size, aes(Size, Sum)) + 
  geom_col() + 
  scale_y_continuous(labels = scales::scientific) +
  ylab(expression("Area (m"^2*")")) +
  scale_x_discrete(labels = label.class) +
  theme_bw()

antal + areal

```

### Estimating the carbon dioxide partial pressure danish lakes
The CO~2~ partial pressure ($u$atm) is calculated from alkalinity (meq L^-1^), pH and water temperature (&deg;C). A total of `r nrow(so_pco2_sf)` records with alkalinity, pH and water temperature from lake surface waters exist from `r length(unique(so_pco2_sf$site_id))` different sampling stations.

```{r so_partpressure, echo=FALSE, message=FALSE, fig.height = 4, fig.width = 5}
so_pco2_sizecat <- so_pco2_sf %>% 
  mutate(sizecat = cut(area, breaks = c(0, 1000, 10^4, 10^5, 10^6, 10^7, 10^8), right = FALSE)) %>% 
  st_set_geometry(NULL)

so_pco2_sizecat %>% 
  select(wtr, ph, alk, pCO2_uatm) %>% 
  rename("Water temp." = wtr, pH = ph, Alkalinity = alk, "CO~2~ part. pres." = pCO2_uatm) %>% 
  gather(Variable, value) %>% 
  group_by(Variable) %>% 
  summarise(Min = min(value), "1st Qu." = quantile(value, 0.25), Median = median(value), 
            Mean = mean(value), "3rd Qu." = quantile(value, 0.75), Max = max(value)) %>% 
  kable(format = "html", digits = 1, caption = "Summary table for water temperature, alkalinity, pH and pCO~2~ in Danish lakes") %>% 
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

```

### Estimating carbon dioxide gas flux from Danish lakes

The CO~2~ gas flux on lakes can be estimated from the gas transfer velocity (*k*) and air-water concentration gradient. *k* is often estimated from empirical relationships, where *k~600~* (*k* standardized to a Schmidt number of 600, which is that of CO~2~ at 20 &deg;C) is a function of wind speed (m s^-1^). Here, five different relationships are included which all depend on wind speed and one that also include area (m^2^). The mean of these five relationships (four when information on area is not present) are used as an estimate of *k~600~*. *k~600~* is converted to the ambient water temperature using the ratio of Schmidt numbers.  

Wind speed is obtained from a DMI data set which contain daily values of wind speed in 20x20 km grids over Denmark from 1989 to 2010 <http://www.dmi.dk/fileadmin/Rapporter/TR/tr12-10.pdf>. These values are used to estimate *k* and in turn the CO~2~ gas flux. 

```{r so_flux, echo=FALSE, message=FALSE}

so_co2_flux <- so_pco2_sizecat %>% 
  mutate(k600_cole = 2.07 + 0.215 * wnd^1.7, 
         k600_crusius_1 = 0.228 * wnd^2.2 + 0.168, 
         k600_crusius_2 = ifelse(wnd < 3.7, 0.72*wnd, 4.33*wnd-13.3),
         k600_vachon_1 = 1.41 + 2.58 * wnd,
         k600_vachon_2 = 2.51 + 1.48 * wnd + 0.39 * wnd * log10(area),
         sc = 1742 + -91.24*wtr + 2.208*wtr^2 + -0.0219*wtr^3,
         k600_mean = ifelse(is.na(area), 
                            (k600_cole + k600_crusius_1 + k600_crusius_2 + k600_vachon_1)/4,
                            (k600_cole + k600_crusius_1 + k600_crusius_2 + k600_vachon_1 + k600_vachon_2)/5),
         kgas = (sc/600)^-0.5 * k600_mean) %>%  #k600 og kgas i cm/h
  mutate(co2_eq_mol_kg = 400 * 10^-6 * K0(S = 0, T = wtr)) %>% 
  mutate(co2_flux_mmol_m2_h = kgas/100*(CO2_mol_kg-co2_eq_mol_kg)*10^6) #%>%  #flux in mmol CO2/m2/h
  #mutate(co2_flux_enhance = chem_enhance_beta(kgas, wtr, ph)*kgas/100*henry*(pco2-400)) #pas på k enhed og enhance
  
so_co2_flux_sizeclass <- so_co2_flux %>% 
  group_by(sizecat) %>% 
  summarise("Number of samples" = n(), 
            "Number of sites" = length(unique(site_id)), 
            Mean = mean(co2_flux_mmol_m2_h, na.rm = TRUE), 
            Std. = sd(co2_flux_mmol_m2_h, na.rm = TRUE)) %>% 
  mutate(Size = c("0-10^3^", "10^3^-10^4^", "10^4^-10^5^", "10^5^-10^6^", "10^6^-10^7^", "10^7^-10^8^", "Ukendt areal")) %>% 
  select(Size, "Number of samples", "Number of sites", Mean, Std.)

so_co2_flux_sizeclass %>% 
  kable(format = "html", digits = 1, caption = "CO~2~ gas flux (mmol m^-2^ h^-1^)  from danish lakes") %>% 
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

```

With the data on area and CO~2~ gas flux now available for each lake size class an upscaling to a national scale can be made. Using a Monte Carlo approach a probable range can be estimated by simulation. For each lake size class, a random draw from a normal distribution with mean and standard deviation given in the previous table for CO~2~ gas flux is multiplied by the corresponding area. This is repeated 1000 times for each lake size class. Finally, a total for all lakes is calculated by summation and summary statistics derived. Gas flux units are converted to XYgrams year^-1^ assuming 365 ice free days. 

```{r so_upscale, echo=FALSE, message=FALSE}
so_upscale <- so_co2_flux_sizeclass %>% 
  filter(!(Size == "Ukendt areal")) %>% 
  left_join(lake_size) %>% 
  mutate(flux_rnorm = map2(Mean, Std., rnorm, n = 1000)) %>% 
  unnest(flux_rnorm) %>% 
  mutate(flux_year = flux_rnorm * Sum * 24 * 365 * 10^-3,
         flux_gigagram = flux_year * 12 * 10^-9)  #flux_year = mol/år, flux_gigagram = gigagram C/år
  
so_upscale %>% 
  group_by(Size) %>% 
  summarise("1st Qu." = quantile(flux_gigagram, 0.25), Median = median(flux_gigagram), 
            Mean = mean(flux_gigagram), "3rd Qu." = quantile(flux_gigagram, 0.75)) %>% 
  kable(format = "html", digits = 1, caption = "CO~2~ gas flux (gigagram C year^-1^) for each lake size class") %>% 
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

so_upscale_tot <- so_upscale %>% 
  select(Size, flux_gigagram) %>% 
  nest(data = c(flux_gigagram))

so_dk_tot <- summarise(so_upscale_tot$data[[1]]+so_upscale_tot$data[[2]]+so_upscale_tot$data[[3]]+
  so_upscale_tot$data[[4]]+so_upscale_tot$data[[5]]+so_upscale_tot$data[[6]], 
  "1st Qu." = quantile(flux_gigagram, 0.25), Median = median(flux_gigagram), 
            Mean = mean(flux_gigagram), "3rd Qu." = quantile(flux_gigagram, 0.75))

```


## Streams and rivers

### Length of Danish streams and rivers
In order to constrain the estimation of carbon dioxide (CO~2~) emissions from danish streams and rivers knowledge on the length and width (area) distribution of danish streams and rivers are required. For streams and rivers, data from two sources are used: The first is from a table in the book *Running waters* and the second is based on data from a map similar to the one used for lakes <https://download.kortforsyningen.dk/content/inspirehy-watercourse>. The map only have watercourses as lines and therefore no information on the width, therefore the sizeproportion of three classes are assumed to be equal for both sources. In this analysis both sources are used as a lower and upper boundary. The watercourse length (km^2^) data for each class is presented in the table below.

```{r vl_length, echo=FALSE}
vl_area <- tibble(sizecat = factor(c("Small", "Medium", "Large"), levels = c("Small", "Medium", "Large")), 
                  width = c("0-2.5 m", "2.5-8 m", ">8 m"), 
       length.book = c(48000, 14500, 1500)) %>% 
  mutate(prop.length.book = c(48000, 14500, 1500)/sum(c(48000, 14500, 1500)),
         length.map = prop.length.book * 86551523/1000)

vl_area %>% 
  select(sizecat, width, length.book, length.map) %>% 
  rename("Size category" = sizecat, Width = width, "Length^1^" = length.book, "Length^2^" = length.map) %>% 
  kable(format = "html", digits = 0, caption = "Length of Danish streams and rivers for each size class") %>% 
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left") %>% 
  add_footnote(c("Running waters","GeoDanmark"), notation = "number")
```

### Estimating the carbon dioxide partial pressure danish streams and rivers

The CO~2~ partial pressure ($u$atm) is calculated from alkalinity (meq L^-1^), pH and water temperature (&deg;C) using the same method as for lakes. A total of `r nrow(vl_pco2)` records with alkalinity, pH and water temperature from streams exist from `r length(unique(vl_pco2$site_id))` different sampling stations. For discharge (m^3^ s^-1^), `r length(na.omit(vl_pco2$q_m3_s))` records from `r dim(vl_pco2[!is.na(vl_pco2$q_m3_s), ])[1]` stations are also available.

```{r vl_partpressure, echo=FALSE, message=FALSE, warning=FALSE}

vl_pco2_hydro <- vl_pco2_sf %>% 
  st_set_geometry(NULL) %>% 
  mutate(v = 0.19*q_m3_s^0.285, 
         d = 0.4*q_m3_s^0.294, 
         w = 12.88*q_m3_s^0.423, 
         fr = v/(9.82*d)^0.5)

vl_stat_sizecat <- vl_pco2_hydro %>% 
  group_by(site_id) %>% 
  summarise(site_id_w = mean(w, na.rm = TRUE)) %>% 
  mutate(sizecat = cut(site_id_w, breaks = c(0, 2.5, 8, 100), 
                       right = FALSE, labels = c("Small", "Medium", "Large"))) %>% 
  na.omit()

vl_sizecat_area <- vl_stat_sizecat %>% 
  group_by(sizecat) %>% 
  summarise(sizecat_w = mean(site_id_w, na.rm = TRUE)) %>% 
  left_join(vl_area) %>% 
  mutate(area.book = length.book * 1000 * sizecat_w,
         area.map = length.map * 1000 * sizecat_w)

vl_pco2_hydro %>% 
  select(wtr, ph, alk, pCO2_uatm) %>% 
  rename("Water temp." = wtr, pH = ph, Alkalinity = alk, "CO~2~ part. pres." = pCO2_uatm) %>% 
  gather(Variable, value) %>% 
  group_by(Variable) %>% 
  summarise(Min = min(value), "1st Qu." = quantile(value, 0.25), Median = median(value), 
            Mean = mean(value), "3rd Qu." = quantile(value, 0.75), Max = max(value)) %>% 
  kable(format = "html", digits = 1, caption = "Summary table for water temperature, alkalinity, pH and pCO~2~ in Danish streams and rivers") %>% 
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

```

### Estimating carbon dioxide gas flux from Danish streams and rivers

Estimates of CO~2~ gas flux from streams and rivers are based on the air-water pCO~2~ gradient and the gas transfer velocity derived from hydraulic geometry and empirical relationships. Using hydraulic scaling, stream velocity (m s^-1^), depth (m) and width are calculation from discharge. *k~600~* values are then estimated from the mean of seven empirical relationships and *k* calculated from the ratio of Schmidt numbers. These relationships are based on the derived hydrological variables and also slope. In this analysis the stream slope (drop/distance, m/m) is calculated for from the stream map. All equations are described in Raymond et al. 2012.  

To upscale the resulting gas flux estimates to national scale, the stations are classified according to size using the mean width. The mean stream width for each size category is then used to calculate the stream area (m^2^) for each category. A similar Monte Carlo approach as used for lakes are then applied. The uncertainty in stream area are in this case represented by an uniform distribution with a lower and upper bound presented in the previous table.

```{r vl_flux, echo=FALSE, message=FALSE}
vl_co2_flux <- vl_pco2_hydro %>% 
  left_join(vl_stat_sizecat) %>% 
  mutate(sc = 1742 + -91.24*wtr + 2.208*wtr^2 + -0.0219*wtr^3,
         k600_1 = (v*slope)^0.89*d^0.54*5037,
         k600_2 = 5937*(1-2.54*fr^2)*(v*slope)^0.89*d^0.58,
         k600_3 = 1162*slope^0.77*v^0.85,
         k600_4 = (v*slope)^0.76*951.5,
         k600_5 = v*slope*2841+2.02,
         k600_6 = 929*(v*slope)^0.75*q_m3_s^0.011,
         k600_7 = 4725*(v*slope)^0.86*q_m3_s^-0.14*d^0.66) %>% #k600 i m/d
  mutate(k600_mean = (k600_1+k600_2+k600_3+k600_4+k600_5+k600_6+k600_7)/7,
         kgas = (sc/600)^-0.5*k600_mean) %>% 
  mutate(co2_eq_mol_kg = 400*10^-6*K0(S = 0, T = wtr)) %>% 
  mutate(co2_flux_mmol_m2_h = kgas/24*(CO2_mol_kg-co2_eq_mol_kg)*10^6) #flux in mmol CO2/m2/h

vl_co2_flux_sizeclass <- vl_co2_flux %>% 
  group_by(sizecat) %>% 
  summarise("Number of samples" = n(), "Number of sites" = length(unique(site_id)), 
            Mean = mean(co2_flux_mmol_m2_h, na.rm = TRUE), Std. = sd(co2_flux_mmol_m2_h, na.rm = TRUE)) %>% 
  na.omit() %>% 
  mutate(Size = factor(c("Small", "Medium", "Large"), levels = c("Small", "Medium", "Large"))) %>% 
  select(Size, "Number of samples", "Number of sites", Mean, Std.)

vl_co2_flux_sizeclass %>% 
  kable(format = "html", digits = 1, caption = "CO~2~ gas flux (mmol m^-2^ h^-1^)  from Danish streams and River") %>% 
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")


```

Using the data on area, the contribution of different size class for Danish streams and rivers to CO~2~ gas flux are presented in the table below. 

```{r vl_upscale, echo=FALSE, message=FALSE}

vl_upscale <- vl_co2_flux_sizeclass %>% 
  left_join(vl_sizecat_area, c("Size" = "sizecat")) %>% 
  mutate(flux_rnorm = map2(Mean, Std., rnorm, n = 1000), 
         area_rnorm = map2(area.book, area.map, runif, n = 1000)) %>%
  mutate(flux_sizecat = map2(flux_rnorm, area_rnorm, `*`)) %>%  #flux_sizecat = mmol CO2/h
  unnest(flux_sizecat) %>% 
  mutate(flux_year = flux_sizecat * 24 * 365 * 10^-3,
         flux_gigagram = flux_year * 12 * 10^-9)  #flux_year = mol/år, flux_gigagram = giga C/år
  
vl_upscale %>% 
  group_by(Size) %>% 
  summarise("1st Qu." = quantile(flux_gigagram, 0.25), Median = median(flux_gigagram), 
            Mean = mean(flux_gigagram), "3rd Qu." = quantile(flux_gigagram, 0.75)) %>% 
  kable(format = "html", digits = 1, caption = "CO~2~ gas flux (gigagram year^-1^) for each size class") %>% 
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

vl_upscale_tot <- vl_upscale %>% 
  select(Size, flux_gigagram) %>% 
  nest(data = c(flux_gigagram))

vl_dk_tot <- summarise(vl_upscale_tot$data[[1]]+vl_upscale_tot$data[[2]]+vl_upscale_tot$data[[3]], 
  "1st Qu." = quantile(flux_gigagram, 0.25), Median = median(flux_gigagram), 
            Mean = mean(flux_gigagram), "3rd Qu." = quantile(flux_gigagram, 0.75))

```

## The carbon dioxide gas flux from Danish inland waters

The average CO~2~ emissions (Tg year^-1^) from Danish lakes, streams and rivers are given in the table below accompanied by summary statistics.

```{r vl_dk, echo=FALSE, message=FALSE}

dk_tot <- bind_rows("Lakes" = so_dk_tot, "Streams and rivers" = vl_dk_tot,
                       "Total" = colSums(bind_rows(so_dk_tot, vl_dk_tot)), .id = "Source") 

dk_tot %>% 
  mutate_if(is.numeric, funs(./1000)) %>% 
  kable(format = "html", digits = 1, caption = "CO~2~ gas flux for Danish inland waters (teragram C year^-1^)") %>% 
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

# #dansk tabel
# dk_tot %>% 
#   add_column("Kilde" = c("Søer", "Vandløb", "Sum")) %>% 
#   rename("Første kvartil" = "1st Qu.", "Tredje kvartil" = "3rd Qu.", Middelværdi = Mean) %>% 
#   select(Kilde, "Første kvartil", Median, Middelværdi, "Tredje kvartil") %>% 
#   kable(format = "html", digits = 1, caption = "CO~2~ afgasning fra danske søer og vandløb (teragram C year^-1^)") %>% 
#   kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

```

```{r samlet_table}
#enhed er gigagram

vl_budget <- vl_upscale_tot %>% 
  unnest() %>% 
  group_by(Size) %>% 
  summarise("1st Qu." = quantile(flux_gigagram, 0.25), 
            Median = median(flux_gigagram), 
            Mean = mean(flux_gigagram), 
            "3rd Qu." = quantile(flux_gigagram, 0.75)) 

so_budget <- so_upscale_tot %>% 
  unnest() %>% 
  group_by(Size) %>%  
  summarise("1st Qu." = quantile(flux_gigagram, 0.25), 
            Median = median(flux_gigagram), 
            Mean = mean(flux_gigagram), 
            "3rd Qu." = quantile(flux_gigagram, 0.75))

dk_budget <- bind_rows("Lakes" = so_budget, 
                       "Streams" = vl_budget, 
                       .id = "Source") 
#write.csv(dk_budget, "H:/Documents/Miljoportalen SOER/dk_budget_table.csv", row.names = FALSE)
```

```{r}
so_vl_flux_rates <- bind_rows(so_co2_flux, vl_co2_flux) %>% 
  select(site_id, system, sizecat, co2_flux_mmol_m2_h, pCO2_uatm) %>% 
  gather(variable, value, co2_flux_mmol_m2_h, pCO2_uatm) %>% 
  na.omit()

so_vl_flux_rates %>%
  ggplot(aes(value, col = sizecat)) + 
  geom_density() +
  scale_color_viridis_d()+
  scale_x_log10()+
  theme_bw()+
  facet_wrap(variable~system, scales = "free")
```

